@page "/admin"
@using Microsoft.AspNetCore.Authorization
@using AnimeFeedManager.WebApp.Services
@using AnimeFeedManager.WebApp.State
@inject IAdminService AdminService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject ApplicationState State
@implements IDisposable

@attribute [Authorize(Roles = "admin")]

<MudContainer MaxWidth="MaxWidth.Large">
    <MudPaper>
        <MudSimpleTable>
            <tbody>
            <tr>
                <td>
                    <MudText Typo="Typo.body1">Automated update latest tv library</MudText>
                    <MudText Typo="Typo.subtitle2">Process in the background feed titles, animes, and images</MudText>
                </td>
                <td style="text-align: right">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Secondary"
                               OnClick="ProcessLibrary">
                        Update
                    </MudButton>
                </td>
            </tr>

            <tr>
                <td>
                    <MudText Typo="Typo.body1">Automated update latest feed titles</MudText>
                    <MudText Typo="Typo.subtitle2">Process in the background feed titles only</MudText>
                </td>
                <td style="text-align: right">
                    <div class="relative d-flex flex-column flex-wrap align-content-end">
                        <MudSelect T="SeasonInfoDto" @bind-Value="@SelectedSeason" ToStringFunc="@Converter" Label="Select season" AnchorOrigin="Origin.BottomCenter" Variant="Variant.Outlined">

                            @foreach (var season in State.Value.AvailableSeasons)
                            {
                                <MudSelectItem Value="@season"/>
                            }
                            <MudButton></MudButton>
                        </MudSelect>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Secondary"
                                   OnClick="ProcessOvasLibrary"
                                   Disabled="SelectedSeason is NullSeasonInfo">
                            Update
                        </MudButton>
                    </div>
                </td>
            </tr>


            <tr>
                <td>
                    <MudText Typo="Typo.body1">Automated update latest ovas library</MudText>
                    <MudText Typo="Typo.subtitle2">Process in the background feed titles only</MudText>
                </td>
                <td style="text-align: right">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Secondary"
                               OnClick="ProcessFeedTitles">
                        Update
                    </MudButton>
                </td>
            </tr>

            <tr>
                <td>
                    <MudText Typo="Typo.body1">Set default state to all</MudText>
                    <MudText Typo="Typo.subtitle2">Set all series completed status to false</MudText>
                </td>
                <td style="text-align: right">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Secondary"
                               OnClick="SetCompletedStatus">
                        Set
                    </MudButton>
                </td>
            </tr>
            </tbody>
        </MudSimpleTable>
    </MudPaper>
</MudContainer>

@code {
    private readonly CancellationTokenSource _cts = new();

    [CascadingParameter]
    private Error? Error { get; set; }

    private SeasonInfoDto SelectedSeason { get; set; } = new NullSeasonInfo();

    protected override void OnInitialized()
    {
        State.OnStateChange += StateHasChanged;
    }

    private async Task ProcessLibrary()
    {
        try
        {
            if (await GetConfirmation("Process Latest TV Season Library", "Do you want to update latest season TV library? This task will run in the background"))
            {
                await AdminService.UpdateTvLibrary(_cts.Token);
                Snackbar.Add("Latest tv season library would be updated in the background", Severity.Info);
            }
        }
        catch (Exception ex)
        {
            Error?.ProcessError("Updating TV Library", ex);
        }
    }

    private async Task ProcessFeedTitles()
    {
        try
        {
            if (await GetConfirmation("Process Latest TV Feed Titles", "Do you want to update latest feed titles? This task will run in the background"))
            {
                await AdminService.UpdateTvTitles(_cts.Token);
                Snackbar.Add("Latest feed titles would be updated in the background", Severity.Info);
            }
        }
        catch (Exception ex)
        {
            Error?.ProcessError("Updating Feed Titles", ex);
        }
    }

    private async Task SetCompletedStatus()
    {
        try
        {
            if (await GetConfirmation("Set Completed Status", "Do you want to set completed the library to completed status false?"))
            {
                await AdminService.SetAllSeriesAsNoCompleted(_cts.Token);
                Snackbar.Add("Series status is being updated in the background", Severity.Info);
            }
        }
        catch (Exception ex)
        {
            Error?.ProcessError("Setting Series Status", ex);
        }
    }

    private async Task ProcessOvasLibrary()
    {
        try
        {
            if (SelectedSeason is not NullSeasonInfo &&
                await GetConfirmation("Process Ovas Library", "Do you want to update latest season TV library? This task will run in the background"))
            {
                await AdminService.UpdateOvasLibrary(SelectedSeason.Season, (ushort)SelectedSeason.Year, _cts.Token);
                Snackbar.Add("Series status is being updated in the background", Severity.Info);
            }
        }
        catch (Exception e)
        {
            Error?.ProcessError("Updating Ovas Library", e);
        }
    }


    private async Task<bool> GetConfirmation(string title, string message)
    {
        var parameters = new DialogParameters { { nameof(ConfirmationDialog.Message), message } };
        var options = new DialogOptions { CloseOnEscapeKey = true };
        var dialog = DialogService.Show<ConfirmationDialog>(title, parameters, options);
        var result = await dialog.Result;
        if (result.Cancelled || result.Data == null) return false;
        return (bool)result.Data;
    }

    public void Dispose()
    {
        State.OnStateChange -= StateHasChanged;
        _cts.Cancel();
        _cts.Dispose();
    }

    private static string Converter(SeasonInfoDto arg) => arg switch {
        NullSeasonInfo => "Select a Season",
        _ =>  $"{arg.Year} - {arg.Season}"
        };


}