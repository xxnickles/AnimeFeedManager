@page "/"
@page "/{Year:int}/{Season}"
@using AnimeFeedManager.WebApp.Services
@using AnimeFeedManager.WebApp.State
@using AnimeFeedManager.Common
@implements IDisposable
@inject ITvCollectionFetcher TvCollectionFetcher
@inject IOvasCollectionService OvasCollectionService
@inject ApplicationState State
@inject NavigationManager NavigationManager

<PageTitle>AFM - @GetTitle(State.Value.SelectedSeason)</PageTitle>
<SeasonSelector AvailableSeasons="@State.Value.AvailableSeasons" SelectedSeason="@State.Value.SelectedSeason" SelectedSeasonChanged="OnSeasonChanged"></SeasonSelector>
@if (_filteredCollection is not  EmptySeasonCollection)
{
    @if (State.Value.SelectedSection == SeriesType.Tv)
    {
        <FilterSelector SelectedFiltersChanged="OnFilterSelectionChanges"></FilterSelector>
    }
    
    <MudTabs Elevation="1" Rounded="true" Position="Position.Top" Border="false" PanelClass="mt-3" Color="Color.Transparent" bi>
        <MudTabPanel Text="TV">
            <SeriesGrid Collection="@_filteredCollection"></SeriesGrid>
        </MudTabPanel>
        <MudTabPanel Text="Ovas">
            <ShortSeriesGrid Collection="@_ovasCollection"></ShortSeriesGrid>
        </MudTabPanel>
    </MudTabs>
}

@code {
    private readonly CancellationTokenSource _cts = new();
    private SeasonCollection _collection = new EmptySeasonCollection();
    private ShortSeasonCollection _ovasCollection = new EmptyShortSeasonCollection();
    private SeasonCollection _filteredCollection = new EmptySeasonCollection();

    [Parameter]
    public int Year { get; set; }

    [Parameter]
    public string Season { get; set; } = string.Empty;

    [CascadingParameter]
    private Error? Error { get; set; }

    private IEnumerable<Func<FeedAnime, bool>> _filters = Enumerable.Empty<Func<FeedAnime, bool>>();

    protected override async Task OnInitializedAsync()
    {
        State.OnStateChange += StateHasChanged;
        State.OnSelectedSeason += OnSelectedSeason;
        if (State.Value.SelectedSeason is not NullSeasonInfo)
        {
            await OnSelectedSeason(State.Value.SelectedSeason);
        }
    }

    private async ValueTask OnSelectedSeason(SeasonInfoDto season)
    {
        const string key = "lo_series";
        try
        {
            State.AddLoadingItem(key, "Loading Series");
            _collection = await TvCollectionFetcher.GetSeasonLibrary(season, _cts.Token);
            _ovasCollection = await OvasCollectionService.GetSeasonLibrary(season, _cts.Token);
            _filteredCollection = FilterCollection(_collection, _filters);
            State.RemoveLoadingItem(key);
        }
        catch (Exception e)
        {
            Error?.ProcessError("Season Collection Fetching", e);
            State.RemoveLoadingItem(key);
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        var result = DtoFactories.TryToParse(Season, Year, out var season);
        if (result)
        {
            await State.SetSelectedSeason(season);
        }
        else
        {
            NavigationManager.NavigateTo("/");
        }
    }

    private static string GetTitle(SeasonInfoDto season) =>
        season is not NullSeasonInfo ? $"{season.Year} - {season.Season.ToUpper()}" : "No Data Available";


    public void Dispose()
    {
        State.OnStateChange -= StateHasChanged;
        State.OnSelectedSeason -= OnSelectedSeason;
        _cts.Cancel();
        _cts.Dispose();
    }

    private void OnSeasonChanged(SeasonInfoDto season)
    {
        NavigationManager.NavigateTo($"/{season.Year}/{season.Season}");
    }

    private void OnFilterSelectionChanges(IEnumerable<Func<FeedAnime, bool>> filters)
    {
        _filters = filters;
        _filteredCollection = FilterCollection(_collection, filters);
    }

    private static SeasonCollection FilterCollection(SeasonCollection collectionBase, IEnumerable<Func<FeedAnime, bool>> filters)
    {
        return new SeasonCollection(
            collectionBase.Year,
            collectionBase.Season,
            collectionBase.Animes.Filter(filters).ToArray());
    }

}